FROM nvidia/cuda:12.1.1-runtime-ubuntu22.04

# Python 3.11 via deadsnakes (Ubuntu 22.04 ships 3.10)
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
 && add-apt-repository -y ppa:deadsnakes/ppa \
 && apt-get update && apt-get install -y --no-install-recommends \
    python3.11 python3.11-venv python3.11-distutils \
    ffmpeg \
 && ln -sf /usr/bin/python3.11 /usr/bin/python \
 && python -m ensurepip --upgrade \
 && apt-get purge -y software-properties-common \
 && apt-get autoremove -y && rm -rf /var/lib/apt/lists/*

# cuDNN 9 runtime (supports all CUDA 12.x including 12.1)
RUN apt-get update \
 && apt-get install -y --no-install-recommends curl gnupg \
 && curl -fsSL https://developer.download.nvidia.com/compute/cudnn/repos/ubuntu2204/x86_64/3bf863cc.pub \
    | gpg --dearmor -o /usr/share/keyrings/cudnn-keyring.gpg \
 && echo "deb [signed-by=/usr/share/keyrings/cudnn-keyring.gpg] https://developer.download.nvidia.com/compute/cudnn/repos/ubuntu2204/x86_64/ /" \
    > /etc/apt/sources.list.d/cudnn.list \
 && apt-get update && apt-get install -y --no-install-recommends libcudnn9-cuda-12 \
 && apt-get purge -y curl gnupg && apt-get autoremove -y \
 && rm -rf /var/lib/apt/lists/*

# Pin torch + torchvision from the PyTorch cu121 index, then install
# application deps. Pinning prevents chatterbox-tts from pulling a newer
# torch that would break torchvision's C++ extensions.
RUN pip install --no-cache-dir \
    torch==2.4.0 torchvision==0.19.0 \
    --index-url https://download.pytorch.org/whl/cu121 \
 && pip install --no-cache-dir \
    chatterbox-tts \
    openai-whisper \
    pysbd \
    pyloudnorm \
    soundfile \
    requests

# Bake Chatterbox model weights into the image so the GPU node has no
# runtime dependency on HuggingFace.
RUN python -c "from chatterbox.tts import ChatterboxTTS; ChatterboxTTS.from_pretrained(device='cpu')"

# Bake Whisper medium model weights (~1.5 GB).
RUN python -c "import whisper; whisper.load_model('medium', download_root='/models/whisper')"

COPY run.py /app/run.py

WORKDIR /app
ENV WHISPER_DOWNLOAD_ROOT=/models/whisper
CMD ["python", "run.py"]
