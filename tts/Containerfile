FROM pytorch/pytorch:2.4.0-cuda12.1-cudnn9-runtime

RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Pin torch and torchvision to versions matching the base image.
# Without these pins, chatterbox-tts pulls in a newer torch (e.g. 2.6)
# via pip, while torchvision 0.19.0 stays behind, causing C++ extension
# mismatches (RuntimeError: operator torchvision::nms does not exist).
RUN pip install --no-cache-dir \
    torch==2.4.0 torchvision==0.19.0 \
    --index-url https://download.pytorch.org/whl/cu121 \
 && pip install --no-cache-dir \
    chatterbox-tts \
    openai-whisper \
    pysbd \
    pyloudnorm \
    soundfile \
    requests

# Bake Chatterbox model weights into the image so the GPU node has no
# runtime dependency on HuggingFace.
RUN python -c "from chatterbox.tts import ChatterboxTTS; ChatterboxTTS.from_pretrained(device='cpu')"

# Bake Whisper medium model weights (~1.5 GB).
RUN python -c "import whisper; whisper.load_model('medium', download_root='/models/whisper')"

COPY run.py /app/run.py

WORKDIR /app
ENV WHISPER_DOWNLOAD_ROOT=/models/whisper
CMD ["python", "run.py"]
