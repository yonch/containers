FROM nvidia/cuda:12.4.1-cudnn-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive

# Python 3.11 via deadsnakes (Ubuntu 22.04 ships 3.10).  cuDNN 9 is
# provided by the -cudnn- base image variant.
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
 && add-apt-repository -y ppa:deadsnakes/ppa \
 && apt-get update && apt-get install -y --no-install-recommends \
    python3.11 python3.11-venv python3.11-distutils \
    curl \
    ffmpeg \
    git \
 && ln -sf /usr/bin/python3.11 /usr/bin/python \
 && python -m ensurepip --upgrade \
 && apt-get purge -y software-properties-common \
 && apt-get autoremove -y && rm -rf /var/lib/apt/lists/*

# Install tts-audiobook-tool from our fork (pinned commit).
# chatterbox-tts 0.1.6 hard-pins torch==2.6.0 which only ships cu124+.
# Install torch from the cu124 index first so the solver respects the pin,
# then the full requirements file which covers chatterbox-tts, faster-whisper,
# and all audio-processing dependencies.
ARG TTS_TOOL_COMMIT=a4875021374ab95b0ad36213639194807a5039a1
RUN git clone https://github.com/yonch/tts-audiobook-tool.git /opt/tts-audiobook-tool \
 && cd /opt/tts-audiobook-tool && git checkout $TTS_TOOL_COMMIT \
 && python -m pip install --no-cache-dir \
    torch==2.6.0 torchaudio==2.6.0 \
    --index-url https://download.pytorch.org/whl/cu124 \
 && python -m pip install --no-cache-dir \
    -r /opt/tts-audiobook-tool/requirements-chatterbox.txt \
 && python -m pip install --no-cache-dir -e /opt/tts-audiobook-tool \
 && python -m pip install --no-cache-dir requests onnxruntime

# Ensure standalone modules in the tts-audiobook-tool root (e.g.
# yamnet_detector) are importable.  pip install -e only exposes packages
# found by setuptools find_packages(), which misses bare .py files.
ENV PYTHONPATH="/opt/tts-audiobook-tool${PYTHONPATH:+:$PYTHONPATH}"

# Model weights are downloaded from S3 at container startup (see run.py
# and the MODELS_URL env var).  The tts-model-upload workflow builds and
# uploads the archive.

COPY run.py /app/run.py

WORKDIR /app
CMD ["python", "run.py"]
